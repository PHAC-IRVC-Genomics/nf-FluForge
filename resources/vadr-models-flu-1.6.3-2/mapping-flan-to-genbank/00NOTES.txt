EPN, Fri Mar 24 14:08:14 2023

Notes on mapping FLAN sequences to GenBank sequences

Knowing the GenBank accessions that map to each FLAN sequence will
make it easier to create VADR models for flu based on the same
sequences that FLAN uses, allowing a somewhat fair comparison of 
VADR and FLAN.

(more voluminous notes in
notebook/23_0207_vadr_flu_models/00LOG.txt)

The FLAN database is available here:
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/

Organization of this file:

- Step 1: Download files from FTP site.
- Step 2: Rename the protein sequences so they all have unique names. 
- Step 3: Download all available INSDC flu sequence accessions using
          NCBI virus and fetch from ID.
- Step 4: Map each of the nucleotide sequences to GenBank sequences.
- Step 5: Map each of the protein sequences to GenBank sequences.
- Step 6: Map FLAN mature peptide sequences to FLAN proteins:
- FLAN sequence files with mapping information:
  o mapped.flan.nt.fa
  o mapped.flan.prot.fa
  o mapped.flan.prot-nt.fa
  o mapped.flan.mature.fa

--------------------------------------------

Step 1: Download files from FTP site

On the FTP site, the sequences are split up into different directories
based on type and segment. The scripts 'wget-A.sh', 'wget-B.sh', and
'wget-C.sh' download the files from the FTP site and rename the
protein sequence files so you don't need the FTP directory structure
to know what type/segment each file corresponds to. For example one
command from the wget-A.sh script is:

wget https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg8/prot1K.fasta -O Aseg8-prot1K.fasta

There is one file with all the nucleotide sequences, downloaded with;
wget https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/blastDB.fasta

--

Step 2: Rename the protein sequences so they all have unique names. 

There are 5 sequence names that occur twice in the protein
fasta files:

> cat `ls *fasta | grep -v renamed` | grep ^\> | sort | uniq -c | sort -rn 
      2 >seg8prot1I
      2 >seg8prot1A
      2 >seg4prot5A
      2 >seg4prot3A
      2 >Seg1prot1A
      1 >seg8prot2B_660872061

I used the scripts 'do-rename.sh' and 'do-rename-mature.sh' to create
new fasta files with the prefix 'renamed.'. Those shell scripts use
the perl script rename-fasta.pl to do the actual work.

--

Step 3: Download all available INSDC flu sequence accessions using
NCBI virus and fetch from ID.

On 3/17/23 I downloaded all nucleotide and protein accessions from NCBI
virus for flu A, B, and C.

flu A nt    897,940 seqs (taxid: 11320)
flu B nt    120,058 seqs (taxid: 11520)
flu C nt      2,475 seqs (taxid: 11552)

flu A prot  1,200,327 seqs
flu B prot    158,844 seqs
flu C prot      2,650 seqs

I then fetched all these sequences using this command:

idfetch -t 5 -c 1 -G <acc.list file> > <fasta file>

--

Step 4: Map each of the nucleotide sequences to GenBank sequences:

I manually split the 'blastDB.fasta' FLAN nucleotide file into 3
files, one each for type A, B, and C, called 'flan.A.nt.fa',
'flan.B.nt.fa', and 'flan.C.nt.fa'.

I then used the find-identical-seqs.pl script  to find identical
sequences between the flan seqs and the GB seqs.

> cat do-find-identical-seqs.sh
perl ./find-identical-seqs.pl flan.A.nt.fa ../ncbi-virus-seqs-20230317/fluA.897490.20230317.nt.fa > flan.A.nt.id
perl ./find-identical-seqs.pl flan.B.nt.fa ../ncbi-virus-seqs-20230317/fluB.120058.20230317.nt.fa > flan.B.nt.id
perl ./find-identical-seqs.pl flan.C.nt.fa ../ncbi-virus-seqs-20230317/fluC.2475.20230317.nt.fa > flan.C.nt.id

There are 46 sequences in the 'blastDB.fasta' file. Of these, 45 have
at least 1 sequence in GB that match identically. Some have more than
one. The sequence A-seg4_H14 does not have an exact match.

For A-seg4_H14, I used web-blast to determine the closest match and
found that it is M35997.1, but M35997.1 is 1749 nt, while A-seg4_H14 is
only 1748 nt. M35997.1 has a single extra C at the end that has been
deleted in A-seg4_14.

4 sequences had more than 1 identical seq in GB:
A-seg4_H16: 4 matches
A-seg7:     4 matches
A-seg8:     3 matches
A-seg4_H6:  2 matches
B-seg4:     2 matches

For these, I fetched the GenBank entry for all 4+4+3+2=13 sequences,
and checked which had CDS annotation. For those with CDS annotation
(which I believe was all of them), I choose the first accession after
a unix sort that derived from GenBank (as opposed to EMBL or DDBJ). 

I created a file uniq.flan.all.nt.id which is manually curated output
from find-identical-seqs.pl (flan.A.nt.id, flan.B.nt.id, and
flan.C.nt.id above) to remove duplicates as explained above and add
the A-seg4_H14 match to M35997.1. I then used the script
'fasta-add-desc-based-on-id.pl' to add the matching GB accessions as
descriptions for the fasta sequences:

> perl fasta-add-desc-based-on-id.pl uniq.flan.all.nt.id ../flan-db-download-20230217/blastDB.fasta > mapped.flan.nt.fa

Then I manually added notes to the description for A-seg4_14 about the
mismatch to M35997.1:

> grep H14 mapped.flan.nt.fa
>A-seg4_H14 M35997.1 the final nt (C) of M35997.1 has been deleted in A-seg4_H14

--------------------------------------------

Step 5: Map each of the protein sequences to GenBank sequences:

For each of the FLAN protein sequences (not mature peptides) I used
the script 'do-find-identical-protein-seqs-in-genbank.sh' which calls
'find-identical-seqs.pl' to find identical seqs in GenBank.

There were 96 protein sequences in the FLAN DB, not counting the
mature peptides. Of those 96:

For 69, there is at least 1 identical protein sequence in GB.
For each of these that had more than 1 identical protein sequence, I
chose 1 representative based on the following priority:

1. accession must have a 'coded_by' attribute that links it to a
   nucleotide sequence in GenBank
2. GI listed in FLAN sequence name, e.g
   Bseg6-prot1A.seg6prot1A_28302102 matches AAO38875.1 (gi: 28302102)
3. coded_by a nt accession in the FLAN nt database 
4. random (pick first found in the downloaded NCBI virus accessions)

coded_by values were added to the find-identical-seqs.pl output by
fetching genpept records, fetching out the coded_by value with
'gb-get-coded-by.pl' and added with id-append-coded-by.pl).

68/69 match criteria 1 above, but Aseg4-protE does not (matches
P26136.1) so it 

This list of 68 is saved in 5 column format in 
flan.prot.68.5col.list

5+ fields:
1. FLAN sequence name (with FTP directory name(s) added to make seq
   names unique as explained above).
2. GenBank accession for best match
3. GI of GB accession in 2
4. 'identical'     for identical match between FLAN seq and GB seq
   'subseq'        if FLAN seq is a subseq of the GB protein seq
   'non-identical' if FLAN seq is not identical and not a subseq of
                   the GB protein seq
5. Nucleotide accession and coordinates that code for the protein
6+. Optional: any additional notes, mostly absent unless field 4 is
    'subseq' or 'non-identical'.

For the remaining 28 sequences, I checked if there is at least one
GenBank protein that the FLAN sequences were a subsequence of. There
is for 14 of the 28.

Some of these 14 had more than 1 GenBank protein that they were a
subsequence of, for those I used the same priority rule as with the 68
to select one representative.

The find-identical-seqs.pl script with the -s1 option outputs how much
sequence is missing in the subsequence, I  used that to *manually*
to create flan.prot.14.subseq.5col.list from flan.14.prot.ssid.list.

The remaining 14 are not a subsequence of any GB protein sequence
(with the exception of Aseg4-protE.seg4protE which matches P216136.1
but P216136.1 doesn't have a coded_by value.)

For these I blasted them against NR/NP using the blastp webserver.

I then took the best hit, and fetched that and used phmmer to compare
to the FLAN sequence it was the best hit for here:
/panfs/pan1/infernal/notebook/23_0207_vadr_flu_models/mapping-flan-db-to-genbank-20230317/individual-hmmering-20230324
> sh ./phmmer.sh

Then I collected notes on how the 14 sequences differ from their best
blastp hits and added that info to the
flan.prot.14.nonidentical.5col.list file.

So the following 3 files contain all the information on mapping the 96
FLAN protein sequences to GenBank sequences. 

68 identical seqs:     flan.prot.68.identical.5col.list
14 subseq seqs:        flan.prot.14.subseq.5col.list
14 non-identical seqs: flan.prot.14.nonidentical.5col.list

> cp flan.prot.68.identical.5col.list flan.prot.14.subseq.5col.list to-save-20230327/
> cat flan.prot.68.identical.5col.list flan.prot.14.subseq.5col.list | sort > flan.prot.96.5col.list

I then created two fasta files:

> perl ./5col-fetch-proteins.pl flan.prot.96.5col.list > mapped.flan.prot.fa
> perl ./5col-fetch-nt.pl flan.prot.96.5col.list > mapped.flan.prot-nt.fa

mapped.flan.prot.fa has the 96 protein sequences, with info on the
mapping in the sequence descriptions.

mapped.flan.prot-nt.fa has the nucleotide sequences that encode the 96
protein sequences (sometimes with frameshifts), with info on the
mapping in the sequence descriptions.

> perl 5col-fetch-prot.pl flan.prot.96.5col.list > mapped.flan.prot.fa
> perl 5col-fetch-nt.pl flan.prot.96.5col.list > mapped.flan.prot-nt.fa

--------------------------------------------

Step 6: Map FLAN mature peptide sequences to FLAN proteins:

The FLAN mature peptides are not relevant to VADR as it uses the
mature peptide boundaries from the protein annotation to define mature
peptides, instead of relying on independent mature peptide sequences
in any way.

But for completeness, I mapped the FLAN mature peptides to the FLAN
proteins by looking to see what FLAN protein sequences each mature
peptide sequence was a subsequence of.

Example command:
> perl ./find-identical-seqs.pl -s1 ../flan-db-download-20230217/renamed.Aseg4-matureP3.fasta ../flan-db-download-20230217/renamed.all.Aseg4-prot.fa > renamed.Aseg4-matureP3.prot.flan.id

The script that does this for all mature peptide sequence files is:
do-find-identical-subseqs-mature-peptides.sh

Then I concatenated all the mature peptide sequences:
> cat ../flan-db-download-20230217/renamed*mature*fasta > all.mature.fa

And all the .id output sequences:
> cat renamed.*mature*prot.flan.id > renamed.all.mature.flan.id

And used a perl script to add the info on identical subseqs as
descriptions for each of the sequences:
> perl fasta-add-desc-based-on-id-mature.pl  renamed.all.mature.flan.id all.mature.fa > mapped.flan.mature.fa

Example name:
>Aseg4-mature3A1.seg4mature3A1 Aseg4-prot3A.seg4prot3A:1..16:+

This means mature peptide sequence Aseg4-mature3A1.seg4mature3A1 is
identical to AAs 1 to 16 of the FLAN protein sequence
Aseg4-prot3A.seg4prot3A.

If a mature peptide is a subsequence of more than one FLAN protein
sequence, then they will be separated by commas in the description (no
whitespace), e.g.:

>Aseg4-matureO1.seg4matureO1  Aseg4-prot7D.seg4prot7D:1..18:+,Aseg4-prot7F.seg4prot7F:1..18:+,Aseg4-protO.seg4protO:1..18:+

--------------------------------------------

FLAN sequence files with mapping information:

The main result of this mapping is 4 fasta files:

1. mapped.flan.nt.fa
2. mapped.flan.prot.fa
3. mapped.flan.prot-nt.fa
4. mapped.flan.mature.fa

---

1. mapped.flan.nt.fa

The 46 nucleotide sequences from FLAN's blastDB.fasta.
Each sequence is named as it is in the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/blastDB.fasta

with an added description that is the GenBank accession that is an
identical sequence and that was chosen as its representative, as
explained in step 4 above.

For example:
>A-seg1 CY002079.1

Sequence 'A-seg1' is identical to CY002079.1.

One sequence has a description:
A-seg4_14, regarding the mismatch to M35997.1:

> grep H14 mapped.flan.nt.fa
>A-seg4_H14 M35997.1 the final nt (C) of M35997.1 has been deleted in A-seg4_H14

> esl-seqstat mapped.flan.nt.fa
Format:              FASTA
Alphabet type:       DNA
Number of sequences: 46
Total # residues:    78816
Smallest:            890
Largest:             2396
Average length:      1713.4

---

2. mapped.flan.prot.fa

The 96 full length protein sequences from FLAN. Each sequence is named
as follows:

{A,B,C}<s1>-<s2>.<s3>

{A,B,C}: 'A', 'B', or 'C' depending on flu type, 'A' sequences from 
         https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/
         'B' sequences from 
         https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-B/
         'C' sequences from 
         https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-C/

<s1>: directory below PROTEIN-{A,B,C} from the FTP directory,
      e.g. 'Seg5' from
      https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-C/Seg5/

<s2>: file name sequence came from, e.g. 'prot1A.fasta' from 
      https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-C/Seg5/prot1A.fasta

<s3>: sequence name from the file specified by <s1> and <s2>, e.g. 'Seq5prot1A'

Full name example:

Cseg5-prot1A.Seg5prot1A

Is the sequence named 'Seg5prot1A' from the file:
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-C/Seg5/prot1A.fasta

The descriptions from these sequences include information on how they 
map to GenBank sequences:

Examples:

A) include 'identical' as 3rd space-delimited field in the description:

E.g.:
>Aseg8-prot1G.seg8prot1G ABL75554.1 119497093 identical EF140699.1:1..660:+

Sequence 'Aseg8-prot1G.seg8prot1G' maps to GenBank sequence ABL75554.1 
with GI 119497093, and it is identical. This protein (the FLAN
sequence and ABL75554.1) is coded by positions 1 to 660 of nucleotide
accession EF140699.1.

B) include 'subseq' as 3rd space-delimited field in the description: 

E.g.
>Aseg8-prot1K.seg8prot1K QDA17383.1 1680941417 subseq MN054469.1:27..710:+

Sequence 'Aseg8-prot1K.seg8prot1K' maps to GenBank sequence QDA17383.1
with GI 1680941417, and it is a subsequence of QDA17383.1. This
protein (the FLAN protein) is
coded by positions 27 to 710 of nucleotide accession MN054469.1.

C) include 'nonidentical' as 3rd space-delimited field in the
description: 

>Aseg4-protE.seg4protE ABI84453.1 115278118 nonidentical CY014604.1:18..1724:+ position_81_is_a_D_in_acc_and_a_H_in_FLAN

Sequence 'Aseg4-protE.seg4protE' maps closest to GenBank sequence
ABI84453.1 with GI 115278118, and the difference with that protein is
that amino acid position 81 is a D in ABI84453.1 and an H in the FLAN
sequence. The ABI84453.1 sequence is coded by positions 18..1724 of 
nucleotide accession CY014604.1.

> esl-seqstat mapped.flan.prot.fa
Format:              FASTA
Alphabet type:       amino
Number of sequences: 96
Total # residues:    37597
Smallest:            52
Largest:             774
Average length:      391.6

---

3. mapped.flan.prot-nt.fa

The 96 nucleotide sequences that encode the 96 FLAN proteins in
mapped.flan.prot.fa, or as close as possible. These are the sequences
and coordinates from field 4 of the descriptions of the sequences in
mapped.flan.prot.fa.

The descriptions are identical to those in mapped.flan.prot.fa, but
the sequence names have changed by appending a '.' and the nucleotide
accession and coordinates. For example:

>Aseg8-prot1G.seg8prot1G.EF140699.1:1..660:+ ABL75554.1 119497093 identical EF140699.1:1..660:+
>Aseg8-prot1K.seg8prot1K.MN054469.1:27..710:+ QDA17383.1 1680941417 subseq MN054469.1:27..710:+
>Aseg4-protE.seg4protE.CY014604.1:18..1724:+ ABI84453.1 115278118 nonidentical CY014604.1:18..1724:+ position_81_is_a_D_in_acc_and_a_H_in_FLAN

The actual nucleotide sequences are from the specified nucleotide
accessions and coordinates that have been appended to the FLAN protein
sequence names.

For example, the sequence
'Aseg8-prot1G.seg8prot1G.EF140699.1:1..660:+' is positions 1 to 660 of
the nucleotide sequence EF140699.1.

> esl-seqstat mapped.flan.prot-nt.fa 
Format:              FASTA
Alphabet type:       DNA
Number of sequences: 96
Total # residues:    112467
Smallest:            159
Largest:             2325
Average length:      1171.5

---

4. mapped.flan.mature.fa

The 72 mature peptide protein sequences from FLAN. Each sequence is named
the same as the sequences in mapped.flan.prot.fa (see above).

Each sequence has a description with 

Examples:
>Aseg4-matureO3.seg4matureO3 Aseg4-protO.seg4protO:340..560:+

The sequence named 'seq4matureO3' from the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg4/matureO3.fasta
is identical to positions 340 to 560 of the protein sequence
'seq4protO' from the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg4/protO.fasta

Another example:

>Aseg4-matureP1.seg4matureP1 Aseg4-prot5A.seg4prot5A:1..16:+,Aseg4-prot5B.seg4prot5A:1..16:+,Aseg4-protP.seg4protP:1..16:+

The sequence named 'seq4matureP1' from the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg4/matureP1.fasta
is identical to positions 1 to 16 of the protein sequence
'seq4prot5A' from the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg4/prot5A.fasta
AND also identical to positions 1 to 16 of the protein sequence 
'seq4prot5A' from the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg4/prot5B.fasta.
AND also identical to positions 1 to 16 of the protein sequence 
'seq4protP' from the file
https://ftp.ncbi.nih.gov/genomes/INFLUENZA/ANNOTATION/PROTEIN-A/Seg4/protP.fasta

> esl-seqstat mapped.flan.mature.fa
Format:              FASTA
Alphabet type:       amino
Number of sequences: 72
Total # residues:    13542
Smallest:            15
Largest:             331
Average length:      188.1

---


